<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Registro Spese</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="manifest" href="manifest.json">
<style>
body { background: #f1f3f6; font-size: 1.1rem; }
.app-card { border-radius: 18px; margin-top: 1rem; }
label { font-weight: 600; margin-bottom: 0.3rem; }
.form-control, .form-select { min-height: 52px; font-size: 1.05rem; border-radius: 14px; }
.btn-save { position: sticky; bottom: 0; width: 100%; border-radius: 0; font-size: 1.2rem; padding: 14px; }
.alert { border-radius: 14px; }
.list-group-item:active { opacity: 0.8; }
</style>
</head>
<body>
<div class="container-fluid px-3 pb-5">
  <div class="card app-card shadow-sm">
    <div class="card-body">
      <h4 class="text-center mb-3">üí∞ Nuova Spesa</h4>
      <form id="spesaForm">
        <div class="mb-3"><label>üìÖ Data</label><input type="date" id="data" class="form-control" required></div>
        <div class="mb-3"><label>‚¨ÜÔ∏è Entrata</label>
          <select id="entrata" class="form-select">
            <option value="">Nessuna</option>
            <option>Stipendio</option>
            <option>Altre Entrate</option>
          </select>
        </div>
        <div class="mb-3"><label>‚¨áÔ∏è Uscita</label>
          <select id="uscita" class="form-select">
            <option value="">Nessuna</option>
            <option>Abbigliamento</option>
            <option>Auto Altre Spese</option>
            <option>Auto Assicurazione</option>
            <option>Auto Benzina</option>
            <option>Auto Bollo</option>
            <option>Auto GPL</option>
            <option>Auto Pedaggi</option>
            <option>Bollette Fibra</option>
            <option>Bollette GAS</option>
            <option>Bollette Luce</option>
            <option>Bollette SIM</option>
            <option>Bollette Spazzatura</option>
            <option>Bollette TV Online</option>
            <option>Casa</option>
            <option>Lavoro Altro</option>
            <option>Lavoro Pranzo</option>
            <option>Lavanderia</option>
            <option>Luisanna</option>
            <option>Mutuo</option>
            <option>Salute</option>
            <option>Spesa Alimentari</option>
            <option>Spese Straordinarie</option>
            <option>Trasporti Altre Spese</option>
            <option>Trasporti Roma</option>
            <option>Uscite</option>
            <option>Vacanza</option>
          </select>
        </div>
        <div class="mb-3"><label>üí∂ Importo</label><input type="number" step="0.01" id="importo" class="form-control" required></div>
        <div class="mb-3"><label>üìù Note</label><textarea id="note" rows="2" class="form-control"></textarea></div>
      </form>
      <div id="messaggio" class="alert alert-success text-center d-none mt-3"></div>
      <hr class="my-4">
      <h5 class="text-center mb-3">üìã Ultime Spese</h5>
      <div id="listaSpese" class="list-group"></div>
      <hr class="my-3">
      <div id="riepilogoMensile" class="text-center p-2 rounded-3 shadow-sm mb-3">
        <div>Entrate: <span id="totEntrate">‚Ç¨ 0.00</span></div>
        <div>Uscite: <span id="totUscite">‚Ç¨ 0.00</span></div>
        <div>Saldo: <span id="saldoMensile">‚Ç¨ 0.00</span></div>
      </div>
    </div>
  </div>
</div>
<button class="btn btn-success btn-save" id="btnSalva">üíæ Salva</button>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxI5gMH6QU__LnT15brQ3vKgGXfHG01e2LsTg1exeUL5jmWDumGombhLRNdwDNN43UZ/exec";

document.getElementById("data").valueAsDate = new Date();

async function caricaSpese(){
  const spese = await fetch(`${SCRIPT_URL}?action=getUltimeSpese`).then(r=>r.json());
  mostraSpese(spese);
  const riepilogo = await fetch(`${SCRIPT_URL}?action=getRiepilogoMensile`).then(r=>r.json());
  document.getElementById("totEntrate").textContent = "‚Ç¨ "+riepilogo.entrate.toFixed(2);
  document.getElementById("totUscite").textContent = "‚Ç¨ "+riepilogo.uscite.toFixed(2);
  const saldoEl = document.getElementById("saldoMensile");
  saldoEl.textContent = "‚Ç¨ "+riepilogo.saldo.toFixed(2);
  saldoEl.style.color = riepilogo.saldo>=0?"green":"red";
}

function mostraSpese(spese){
  const lista = document.getElementById("listaSpese");
  lista.innerHTML="";
  if(spese.length===0){ lista.innerHTML="<div class='text-center text-muted'>Nessuna spesa</div>"; return; }
  spese.forEach(s=>{
    const colore = s.entrata?"success":"danger";
    const titolo = s.entrata || s.uscita;
    const item = document.createElement("a");
    item.href="#";
    item.className=`list-group-item list-group-item-${colore} d-flex justify-content-between align-items-center text-start`;
    item.style.cursor="pointer";
    item.innerHTML=`<div><strong>${titolo}</strong><br><small>${s.data} ${s.note?"‚Ä¢ "+s.note:""}</small></div><span class="fw-bold">‚Ç¨ ${Number(s.importo).toFixed(2)}</span>`;
    lista.appendChild(item);
  });
}

document.getElementById("btnSalva").addEventListener("click", async ()=>{
  const data = document.getElementById("data").value;
  const entrata = document.getElementById("entrata").value;
  const uscita = document.getElementById("uscita").value;
  const importo = document.getElementById("importo").value;
  const note = document.getElementById("note").value;
  const msgBox = document.getElementById("messaggio");

  msgBox.classList.add("d-none");
  if(!data){ msgBox.textContent="Seleziona una data"; msgBox.className="alert alert-danger text-center mt-3 d-block"; return; }
  if(!entrata && !uscita){ msgBox.textContent="Seleziona Entrata o Uscita"; msgBox.className="alert alert-danger text-center mt-3 d-block"; return; }
  if(entrata && uscita){ msgBox.textContent="Seleziona solo una voce"; msgBox.className="alert alert-danger text-center mt-3 d-block"; return; }
  if(!importo || importo<=0){ msgBox.textContent="Importo non valido"; msgBox.className="alert alert-danger text-center mt-3 d-block"; return; }

  try{
    const res = await fetch(`${SCRIPT_URL}?action=salvaSpesa&data=${data}&entrata=${entrata}&uscita=${uscita}&importo=${importo}&note=${note}`);
    const result = await res.json();
    if(result.error){ throw new Error(result.error); }
    msgBox.textContent=result; msgBox.className="alert alert-success text-center mt-3 d-block";
    document.getElementById("spesaForm").reset();
    document.getElementById("data").valueAsDate=new Date();
    caricaSpese();
  }catch(err){
    msgBox.textContent="Errore: "+err.message;
    msgBox.className="alert alert-danger text-center mt-3 d-block";
  }
});

window.onload=caricaSpese;
</script>
</body>
</html>
